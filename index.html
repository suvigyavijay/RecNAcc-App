<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
  <title>RecNAcc App | DVM</title>

  <!-- CSS  -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
</head>
<body>
  <sideNav>
    <ul id="slide-out" class="side-nav fixed primary-color">
      <li class="row constant">
        <br>
        <div class="col s6 offset-s3">
          <img src="img/logo_dvm.svg">
        </div>
      </li>
      <div class="row variable" id="navMenu">
        <li><a href="#" class="white-text"><i class="material-icons md-light white-text">vpn_key</i>Login</a></li>
      </div>
    </ul>
    <a id="hamButton" href="#" data-activates="slide-out" class="button-collapse btn-floating btn-large primary-color"><i class="material-icons">menu</i></a>
  </sideNav>
  <main>
    <div class="container">
      <div class="vertical-align center-align" id="loginForm">
        <div class="row red-text" id="loginError">

        </div>
        <div class="row">
          <div class="input-field col s12 m6 offset-m3 left-align">
            <input id="email" type="email" class="validate" value="a@a.asd">
            <label for="email">Email</label>
          </div>
          <div class="input-field col s12 m6 offset-m3 left-align">
            <input id="password" type="password" class="validate" value="qwerty" onkeypress="handleLogin(event)">
            <label for="password">Password</label>
          </div>
        </div>
        <div class="row">
          <button class="btn waves-effect waves-light col s4 offset-s8 m2 offset-m7" type="submit" name="action" id="loginButton" >Login
            <i class="material-icons right">send</i>
          </button>
        </div>
      </div>
      <div id="loggedIn hidden">
        <div id="plsSelect" class="vertical-align">
          <div class="row">
            <a class="waves-effect waves-light btn-large col s12 m6 offset-m3" id="dcButton"><i class="material-icons left">domain</i>Department/Club</a>
          </div>
          <div class="row">
            <a class="waves-effect waves-light btn-large col s12 m6 offset-m3"><i class="material-icons left">shopping_cart</i>Tender D/C</a>
          </div>
          <div class="row">
            <a class="waves-effect waves-light btn-large col s12 m6 offset-m3"><i class="material-icons left">local_hotel</i>Matress D/C</a>
          </div>
        </div>
        <div id="deptClub" class="hidden">
          <div id="dcS1">
            <div class="vertical-align">
              <div class="row red-text center-align" id="ucError">

              </div>
              <div class="row">
                <div class="input-field col s12 m6 offset-m3">
                  <input id="uniqueCode" type="text" class="validate" maxlength="6" onkeypress="handleUC(event)">
                  <label for="uniqueCode">Unique Code</label>
                </div>
              </div>
              <div class="row">
                <button class="btn waves-effect waves-light col s4 offset-s8 m2 offset-m7" type="submit" name="action" id="ucButton">Submit
                  <i class="material-icons right">send</i>
                </button>
              </div>
            </div>
          </div>
          <div id="dcS2" class="hidden">
            <div class="vertical-align">
              <h3 class="dc-name center-align" id="dcName"></h3>
              <div class="row">
                <a class="waves-effect waves-light btn-large col s12 m6 offset-m3" id="newEntryButton"><i class="material-icons left">mode_edit</i>New Entry</a>
              </div>
              <div class="row">
                <a class="waves-effect waves-light btn-large col s12 m6 offset-m3" id="returnButton"><i class="material-icons left">assignment_return</i>Return</a>
              </div>
              <div class="row">
                <a class="waves-effect waves-light btn-large col s12 m6 offset-m3" id="viewButton"><i class="material-icons left">history</i>View Status</a>
              </div>
            </div>
          </div>
          <div id="dcS3">
            <div id="dc_entry" class="hidden">
              <div class="vertical-align">
                <div class="row">
                  <div class="input-field col s12 m6 offset-m3">
                    <input class="nBlanket" id="nBlanket" placeholder="" type="text" class="validate">
                    <label for="nBlanket">No of Blankets</label>
                  </div>
                  <div class="input-field col s12 m6 offset-m3">
                    <input class="nMattress" id="nMattress" placeholder="" type="text" class="validate">
                    <label for="nMattress">No of Mattresses</label>
                  </div>
                  <div class="input-field col s12 m6 offset-m3">
                    <input class="nPillow" id="nPillow" placeholder="" type="text" class="validate">
                    <label for="nPillow">No of Pillows</label>
                  </div>
                  <div class="input-field col s12 m6 offset-m3">
                    <input class="nSpike" id="nSpike" placeholder="" type="text" class="validate">
                    <label for="nSpike">No of Spike Guards</label>
                  </div>
                  <button class="btn waves-effect waves-light col s4 offset-s8 m2 offset-m7" type="submit" name="action" id="newEntrySubmit">Submit
                    <i class="material-icons right">send</i>
                  </button>
                </div>
              </div>
            </div>
            <div id="dc_return" class="hidden">
              <div class="vertical-align">
                <div class="row">
                  <div class="input-field col s12 m6 offset-m3">
                    <input id="rBlanket" value="0" type="text" class="validate">
                    <label for="rBlanket">No of Blankets</label>
                  </div>
                  <div class="input-field col s12 m6 offset-m3">
                    <input id="rMattress" value="0" type="text" class="validate">
                    <label for="rMattress">No of Mattresses</label>
                  </div>
                  <div class="input-field col s12 m6 offset-m3">
                    <input id="rPillow" value="0" type="text" class="validate">
                    <label for="rPillow">No of Pillows</label>
                  </div>
                  <div class="input-field col s12 m6 offset-m3">
                    <input id="rSpike" value="0" type="text" class="validate">
                    <label for="rSpike">No of Spike Guards</label>
                  </div>
                  <button class="btn waves-effect waves-light col s4 offset-s8 m2 offset-m7" type="submit" name="action" id="returnSubmit">Submit
                    <i class="material-icons right">send</i>
                  </button>
                </div>
              </div>
            </div>
            <div id="dc_view" class="hidden">
              <div class="vertical-align">
                <div class="row">
                  <div class="input-field col s12 m6 offset-m3">
                    <input class="nBlanket" id="vBlanket" placeholder="" type="text" class="validate" disabled>
                    <label for="vBlanket">No of Blankets</label>
                  </div>
                  <div class="input-field col s12 m6 offset-m3">
                    <input class="nMattress" id="vMattress" placeholder="" type="text" class="validate" disabled>
                    <label for="vMattress">No of Mattresses</label>
                  </div>
                  <div class="input-field col s12 m6 offset-m3">
                    <input class="nPillow" id="vPillow" placeholder="" type="text" class="validate" disabled>
                    <label for="vPillow">No of Pillows</label>
                  </div>
                  <div class="input-field col s12 m6 offset-m3">
                    <input class="nSpike" id="vSpike" placeholder="" type="text" class="validate" disabled>
                    <label for="vSpike">No of Spike Guards</label>
                  </div>
                  <button class="btn waves-effect waves-light col s4 offset-s8 m2 offset-m7" type="submit" name="action" id="viewBack">Back
                    <i class="material-icons right">backspace</i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="tenderDC" class="hidden">

        </div>
        <div id="matressDC" class="hidden">

        </div>
        <div id="revision" class="hidden">
          <h3>Revision History</h3>
          <ul class="collapsible" data-collapsible="expandable" id="revisionData">

          </ul>
        </div>
      </div>
    </div>
  </main>
  <footer>

  </footer>

  <!--  Scripts-->
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="js/materialize.js"></script>
  <script src="js/init.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.4.1/firebase.js"></script>
  <script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyBxzLUFVpUeT3mejr3k35D39vtsicJVYvw",
    authDomain: "recnacc-app.firebaseapp.com",
    databaseURL: "https://recnacc-app.firebaseio.com",
    storageBucket: "recnacc-app.appspot.com",
    messagingSenderId: "174568663971"
  };
  firebase.initializeApp(config);
</script>
<script type="text/javascript">

  // $( function() {
  //   $( "#hamButton" ).draggable();
  //   $( "#hamButton i" ).draggable();
  // } );

  function login(email,password) {
    firebase.auth().signInWithEmailAndPassword(email, password).then(
      function() {
        $('#loginError').html('');
        $('#loginForm').fadeOut();
        console.log('Login Successful!');
        var navlist = '<li><a href="#" class="white-text" id="dcNavButton"><i class="material-icons md-light white-text">domain</i>Department/Club</a></li><li><a href="#" class="white-text"><i class="material-icons md-light white-text">shopping_cart</i>Tender D/C</a></li><li><a href="#" class="white-text"><i class="material-icons md-light white-text">local_hotel</i>Matress D/C</a></li><li><a href="#" class="white-text" onclick="logout()"><i class="material-icons md-light white-text">vpn_key</i>Logout</a></li>';
        if (firebase.auth().currentUser.email=='superuser@bits-oasis.org') {
          navlist = '<li><a href="#" class="white-text" id="dcNavButton"><i class="material-icons md-light white-text">domain</i>Department/Club</a></li><li><a href="#" class="white-text"><i class="material-icons md-light white-text">shopping_cart</i>Tender D/C</a></li><li><a href="#" class="white-text"><i class="material-icons md-light white-text">local_hotel</i>Matress D/C</a></li>'+'<li><a href="#" class="white-text" id="revisionButton"><i class="material-icons md-light white-text">watch_later</i>View Revision History</a></li>'+'<li><a href="#" class="white-text" onclick="logout()"><i class="material-icons md-light white-text">vpn_key</i>Logout</a></li>';
        }
        $('#navMenu').html(navlist);
        $('#loggedIn').fadeIn();
        $('#dcNavButton').click(function() {
          $('#plsSelect').hide();
          $('#dcS1').fadeIn();
          $('#dcS2').hide();
          $('#dcS3').hide();
          $('#deptClub').show();
        })
      },
      function(error) {
      // Handle Errors here.
      var errorCode = error.code;
      var errorMessage = error.message;
      console.log(errorMessage);
      $('#loginError').html(errorMessage);
    });
  }

  function logout() {
    firebase.auth().signOut().then(function() {
      $('#loggedIn').fadeOut();
      $('#loginForm').fadeIn();
      var navlist = '<li><a href="#" class="white-text"><i class="material-icons md-light white-text">vpn_key</i>Login</a></li>';
      $('#navMenu').html(navlist);
      console.log('Logout Successful!');
    }, function(error) {
      Materialize.toast('An Error Occured. Please Try Again');
    });
  }

  function accessDC(uniqueCode) {
    firebase.database().ref('deptClub/'+uniqueCode).once('value',function(snapshot) {
      if (snapshot.val().name!=undefined) {
        $('#ucError').html('');
        $('#dcS1').hide();
        $('header').show();
        $('#dcName').html(snapshot.val().name);
        $('#dcS2').show();
      }
      else {
        $('#ucError').html('Invalid Unique Code');
      }
    })
  }

  var readyReturn = false;

  function retrieveDCDetails(uniqueCode) {
    var active_DC = firebase.database().ref('deptClub/'+uniqueCode);
    active_DC.child('data').once('value',function(snapshot) {
      $('.nBlanket').val(snapshot.val().blanket);
    });
    active_DC.child('data').once('value',function(snapshot) {
      $('.nMattress').val(snapshot.val().mattress);
    });
    active_DC.child('data').once('value',function(snapshot) {
      $('.nPillow').val(snapshot.val().pillow);
    });
    active_DC.child('data').once('value',function(snapshot) {
      $('.nSpike').val(snapshot.val().spike);
      readyReturn = true;
    });
  }

  function returnDC(uniqueCode) {
    if (readyReturn===true) {
      console.log(readyReturn);
      var active_DC = firebase.database().ref('deptClub/'+uniqueCode);
      active_DC.child('data/blanket').set($('#nBlanket').val()-$('#rBlanket').val());
      active_DC.child('data/mattress').set($('#nMattress').val()-$('#rMattress').val());
      active_DC.child('data/pillow').set($('#nPillow').val()-$('#rPillow').val());
      active_DC.child('data/spike').set($('#nSpike').val()-$('#rSpike').val());
    }
    else{
      console.log(readyReturn);
      setTimeout(function () {
        requestAnimationFrame(returnDC(uniqueCode));
      },500)
    }
  }

  function updateDCDetails(uniqueCode) {
    var active_DC = firebase.database().ref('deptClub/'+uniqueCode);
    active_DC.child('data/blanket').set($('#nBlanket').val());
    active_DC.child('data/mattress').set($('#nMattress').val());
    active_DC.child('data/pillow').set($('#nPillow').val());
    active_DC.child('data/spike').set($('#nSpike').val());
    readyReturn = false;
  }

  function updateRevisionHistory(areaName, uniqueCode) {
    var active_DC = firebase.database().ref('deptClub/'+uniqueCode);
    var rev_history = firebase.database().ref('rev_history');
    var count = undefined;
    var name, data;
    var timestamp = new Date().toLocaleString();
    var currentUser = firebase.auth().currentUser.email;
    active_DC.child('name').once('value', function(snapshot) {
      name = snapshot.val();
    })
    active_DC.child('data').once('value', function(snapshot) {
      data = snapshot.val();
    })
    rev_history.child('count').once('value', function(snapshot) {
      count = snapshot.val();
      console.log(count);
      // count = parseInt(count)+1;
      // console.log(count);
      var jsonData = {
        'count': count+1
      };
      jsonData[count+1] = {
        'timestamp': timestamp,
        'user': currentUser,
        'changelog': {
          'changes': areaName,
          'name': name,
          'data': data,
        }
      };
      rev_history.update(jsonData);
    });
  }

  function viewRevision() {
    var htmlstring = '<li><div class="collapsible-header">'+iter+'</div><div class="collapsible-body"></div></li>'
  }

  function handleLogin(e){
    if(e.keyCode === 13){
       e.preventDefault(); // Ensure it is only this code that rusn
       $('#loginButton').click();
     }
   }

   function handleUC(e){
    if(e.keyCode === 13){
      e.preventDefault(); // Ensure it is only this code that rusn
      $('#ucButton').click();
    }
  }

  $('#loginButton').click(function(e) {
    var email = $('#email').val();
    var password = $('#password').val();
    login(email, password);
  });

  var uniqueCode='';

  $('#ucButton').click(function () {
    uniqueCode = $('#uniqueCode').val();
    accessDC(uniqueCode);
  })

  $('#dcButton').click(function() {
    $('#plsSelect').fadeOut();
    $('#deptClub').fadeIn();
  })

  $('#newEntryButton').click(function() {
    $('#dcS2').fadeOut();
    retrieveDCDetails(uniqueCode);
    $('#dcS3').show();
    $('#dc_entry').show();
  })

  $('#newEntrySubmit').click(function() {
    $('#dcS3').fadeOut();
    $('#dc_entry').fadeOut();
    updateDCDetails(uniqueCode);
    updateRevisionHistory('deptClub', uniqueCode);
    $('#dcS2').show();
  })

  $('#returnButton').click(function() {
    $('#dcS2').fadeOut();
    retrieveDCDetails(uniqueCode);
    $('#dcS3').show();
    $('#dc_return').show();
  })

  $('#returnSubmit').click(function() {
    $('#dcS3').fadeOut();
    $('#dc_return').fadeOut();
    retrieveDCDetails(uniqueCode);
    returnDC(uniqueCode);
    updateRevisionHistory('deptClub', uniqueCode);
    $('#dcS2').show();
  })

  $('#viewButton').click(function() {
    $('#dcS2').fadeOut();
    retrieveDCDetails(uniqueCode);
    $('#dcS3').show();
    $('#dc_view').show();
  })

  $('#viewBack').click(function() {
    $('#dc_view').fadeOut();
    $('#dcS3').fadeOut();
    $('#dcS2').show();
  })

</script>

</body>
</html>
